# Package Maintenance (Packaging)

This document details the technical procedures for maintaining and updating Wormhole packages for the different supported package managers.

## Overview

Wormhole officially supports the following formats:

- Rust Crates (crates.io)
- Arch Linux (AUR)
- Nix / NixOS (Flakes)
- Debian / Ubuntu (.deb)
- Fedora / RedHat (.rpm)
- Windows (Installer .exe)

Most binary generation is automated via GitHub Actions during Release creation, but some metadata must be updated manually before tagging a new version.

## 1. Rust (Cargo)

This is the source of truth. Everything starts with `Cargo.toml`.

### Before releasing

1. **Update the version in `Cargo.toml`:**

```toml
[package]
name = "wormhole-fs"
version = "0.X.Y"  # <- Update here
```

1. **Update `Cargo.lock`:**

```sh
cargo update
cargo build
```

1. **Commit these changes.**

## 2. Debian (.deb) and Fedora (.rpm)

Package generation is entirely managed by CI (GitHub Actions) via `cargo-deb` and `cargo-generate-rpm` tools.

### Maintenance

Metadata is found directly in `Cargo.toml`:

- Debian: Section `[package.metadata.deb]`
- RPM: Section `[package.metadata.generate-rpm]`

### Points to watch

- Verify that systemd service files (`service/wormhole.service`) are included in assets.
- If you add a system dependency (e.g., `libfuse3`), add it to the `depends` or `requires` fields in these sections in `Cargo.toml`.

## 3. Arch Linux (AUR)

The AUR package is defined by the `PKGBUILD` file at the root. This step often requires the most manual work.

### Files involved

- `PKGBUILD`
- `.SRCINFO`

### Update procedure

1. **Calculate source hash:** If releasing v0.2.0, download the source archive generated by GitHub or create it locally, then obtain its SHA256 hash.

2. **Update `PKGBUILD`:**

```bash
pkgver=0.2.0        # Update version
sha256sums=('...')  # Update source archive hash
```

1. **Generate `.SRCINFO`:** You must regenerate this file each time you modify `PKGBUILD`.

```sh
makepkg --printsrcinfo > .SRCINFO
```

1. **Test the build locally:**

```sh
makepkg -si
```

1. **Publish to AUR:** (Requires maintainer rights on the AUR repository `wormhole-fs` or `wormhole-git`). Commit `PKGBUILD` and `.SRCINFO` to the AUR git repository.

## 4. Nix / NixOS

Wormhole uses Flakes for perfect reproducibility.

### Files involved

- `flake.nix`
- `flake.lock`

### Update procedure

1. **If Rust dependencies (`Cargo.lock`) have changed,** the vendoring hash (`cargoHash`) in the Nix package definition may change.

2. **To update flake inputs** (e.g., nixpkgs version used for the build):

```sh
nix flake update
```

1. **Verify the build works:**

```sh
nix build .#default
```

1. **If the build fails due to SHA256 hash mismatch** (often related to Rust crates), Nix will tell you the expected hash. Update the `cargoHash` or `vendorHash` field in `nix/package.nix` (or directly in `flake.nix` depending on the implementation).

## 5. Windows (Inno Setup)

The Windows installer is generated via Inno Setup.

### Files involved

- `.github/installer.iss`

### Maintenance

The `.iss` file contains the installation logic. CI typically injects the version dynamically, but if you modify the folder structure (adding new binaries, changing DLL names), you must update the `[Files]` section of the `.iss` file.

```ini
[Files]
Source: "target\release\wormhole.exe"; DestDir: "{app}"; Flags: ignoreversion
Source: "target\release\wormholed.exe"; DestDir: "{app}"; Flags: ignoreversion
; Add other DLLs here if necessary (e.g., WinFSP if we decide to bundle it)
```

## 6. Docker / OCI (GHCR)

The official Docker image is published on the GitHub Container Registry.

### Files involved

- `Dockerfile`
- `.github/workflows/release.yml` (or dedicated Docker workflow)

### Maintenance

The Dockerfile at the root must remain capable of building the project. If you need to manually push an image (in case of CI failure):

```sh
# Login to GitHub Container Registry
echo $CR_PAT | docker login ghcr.io -u USERNAME --password-stdin

# Build
docker build -t ghcr.io/agartha-software/wormhole:v0.2.0 .

# Push
docker push ghcr.io/agartha-software/wormhole:v0.2.0

# Tag latest
docker tag ghcr.io/agartha-software/wormhole:v0.2.0 ghcr.io/agartha-software/wormhole:latest
docker push ghcr.io/agartha-software/wormhole:latest
```

## Release Workflow Summary

To release a new version (e.g., 0.2.0):

1. **Code:** Update `Cargo.toml` version to 0.2.0.
2. **Arch:** Update `PKGBUILD` `pkgver` to 0.2.0 + hash. Regenerate `.SRCINFO`.
3. **Nix:** Run `nix flake check` to validate.
4. **Git:** Commit `"chore: bump version to 0.2.0"`.
5. **Tag:** `git tag v0.2.0`.
6. **Push:** `git push origin v0.2.0`.
7. **CI:** GitHub Actions will trigger:
   - Build Linux/Windows binaries.
   - Create `.deb` and `.rpm` files.
   - Create Windows installer.
   - Create a "Draft Release" on GitHub with all these files attached.
