#!/bin/bash
#
# Assistant de montage pour 'fuse.wormhole'
# Appelé par /sbin/mount.fuse via l'option 'subtype=wormhole'
#
set -e

WORMHOLE_CLI="/bin/wormhole"
LOG_FILE="/tmp/mount_helper.log"

echo "--- mount.fuse.wormhole SCRIPT START ---" > $LOG_FILE
echo "Args: $@" >> $LOG_FILE

# --- 1. Initialiser les valeurs par défaut ---
POD_NAME="default_pod"
PORT="5000"
MOUNT_POINT="$2" # Le point de montage est toujours $2
OPTIONS_STRING=""

# --- 2. Parser les options (CORRIGÉ) ---
# $3 contient les options, ex: -o rw,subtype=wormhole,pod_name=testpod
if [ -n "$3" ]; then
    # Enlève le '-o' du début
    OPTIONS_STRING=$(echo "$3" | sed 's/^-o//')
fi

echo "Parsing options: $OPTIONS_STRING" >> $LOG_FILE

# Change le séparateur (IFS) en virgule pour la boucle
OLD_IFS=$IFS
IFS=','
for opt in $OPTIONS_STRING; do
    # Sépare la clé et la valeur
    key=$(echo "$opt" | cut -d'=' -f1)
    value=$(echo "$opt" | cut -d'=' -f2)

    case "$key" in
        pod_name)
            POD_NAME=$value
            ;;
        port)
            PORT=$value
            ;;
        *)
            # Ignorer les options inconnues (rw, subtype, allow_other, etc.)
            ;;
    esac
done
# Restaure l'ancien séparateur
IFS=$OLD_IFS

echo "Parsed values:" >> $LOG_FILE
echo "  POD_NAME: $POD_NAME" >> $LOG_FILE
echo "  PORT: $PORT" >> $LOG_FILE
echo "  MOUNT_POINT: $MOUNT_POINT" >> $LOG_FILE

# --- 3. Exécuter la commande de montage ---
echo "Running: $WORMHOLE_CLI new $POD_NAME -p $PORT -m $MOUNT_POINT" >> $LOG_FILE

$WORMHOLE_CLI new "$POD_NAME" -p "$PORT" -m "$MOUNT_POINT" >> $LOG_FILE 2>&1

sleep 2

# --- 4. Vérifier et quitter ---
if ! mount | grep -q -- "$MOUNT_POINT"; then
    echo "ERREUR: Le montage FUSE n'a pas pu être détecté sur $MOUNT_POINT" >> $LOG_FILE
    echo "--- mount.fuse.wormhole SCRIPT FAILED ---" >> $LOG_FILE
    exit 1
fi

echo "Montage réussi." >> $LOG_FILE
echo "--- mount.fuse.wormhole SCRIPT SUCCESS ---" >> $LOG_FILE
exit 0