#!/bin/bash
#
# Assistant de montage pour 'fuse.wormhole'
# Appelé par /sbin/mount.fuse via l'option 'subtype=wormhole'
#
set -e

WORMHOLE_CLI="/bin/wormhole"
LOG_FILE="/tmp/mount_helper.log"

echo "--- mount.fuse.wormhole SCRIPT START ---" > $LOG_FILE
echo "Args: $*" >> $LOG_FILE

# --- 1. Initialize the default values ---
POD_NAME="default_pod"
PORT="5000"
MOUNT_POINT="" 
OPTIONS_STRING=""

# --- 2. Récupérer le point de montage et les options ---
# Le point de montage est généralement le dernier argument qui n'est pas une option,
# mais dans le cas d'un helper fuse, l'appel est souvent : dev dir -o options
# $1 = device (ignoré ici "non1")
# $2 = mountpoint
MOUNT_POINT="$2"

# On décale les arguments pour traiter le reste
shift 2

# Boucle pour trouver -o dans les arguments restants
while [ $# -gt 0 ]; do
    case "$1" in
        -o)
            # Cas où -o est séparé par un espace (ex: -o rw,user)
            shift
            OPTIONS_STRING="$1"
            ;;
        -o*)
            # Cas où -o est collé (ex: -orw,user)
            OPTIONS_STRING="${1#-o}"
            ;;
        *)
            ;;
    esac
    shift
done

echo "Parsing options text: $OPTIONS_STRING" >> $LOG_FILE

# Change the separator (IFS) to comma for the loop
OLD_IFS=$IFS
IFS=','
for opt in $OPTIONS_STRING; do
    # Separate the key and the value
    key=$(echo "$opt" | cut -d'=' -f1)
    value=$(echo "$opt" | cut -d'=' -f2)

    case "$key" in
        pod_name)
            POD_NAME=$value
            ;;
        port)
            PORT=$value
            ;;
        *)
            # Ignore the unknown options (rw, subtype, allow_other, etc.)
            ;;
    esac
done
# Restore the old separator
IFS=$OLD_IFS

echo "Parsed values:" >> $LOG_FILE
echo "  POD_NAME: $POD_NAME" >> $LOG_FILE
echo "  PORT: $PORT" >> $LOG_FILE
echo "  MOUNT_POINT: $MOUNT_POINT" >> $LOG_FILE

# --- 3. Execute the mount command ---
echo "Running: $WORMHOLE_CLI new $POD_NAME -p $PORT -m $MOUNT_POINT" >> $LOG_FILE

# On redirige stderr vers stdout pour le capturer dans le log en cas d'erreur
$WORMHOLE_CLI new "$POD_NAME" -p "$PORT" -m "$MOUNT_POINT" >> $LOG_FILE 2>&1

sleep 2

# --- 4. Verify and exit ---
if ! mount | grep -q -- "$MOUNT_POINT"; then
    echo "ERROR: The FUSE mount has not been detected on $MOUNT_POINT" >> $LOG_FILE
    echo "--- mount.fuse.wormhole SCRIPT FAILED ---" >> $LOG_FILE
    exit 1
fi

echo "Mount successful." >> $LOG_FILE
echo "--- mount.fuse.wormhole SCRIPT SUCCESS ---" >> $LOG_FILE
exit 0